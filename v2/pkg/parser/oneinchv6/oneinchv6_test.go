package oneinchv6

import (
	"context"
	"encoding/hex"
	"encoding/json"
	"math/big"
	"os"
	"strings"
	"testing"
	"time"

	types2 "github.com/KyberNetwork/tradelogs/v2/pkg/types"
	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/require"
)

var rpcURL = os.Getenv("TEST_RPC_URL")

func TestFetchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	p := MustNewParser()
	require.Equal(t, p.abi.Events[FilledEvent].ID, common.HexToHash("0xfec331350fce78ba658e082a71da20ac9f8d798a99b3c79681c8440cbfe77e07"))
	client, err := ethclient.Dial(rpcURL)
	require.NoError(t, err)
	logs, err := client.FilterLogs(context.Background(), ethereum.FilterQuery{
		BlockHash: nil,
		FromBlock: big.NewInt(20890481),
		ToBlock:   big.NewInt(20890481),
		Addresses: nil,
		Topics: [][]common.Hash{
			{
				p.abi.Events[FilledEvent].ID,
			},
		},
	})
	require.NoError(t, err)
	d, err := json.Marshal(logs)
	require.NoError(t, err)
	t.Log(string(d))
}

func TestParseEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `[{"address":"0x111111125421ca6dc452d289314280a0f8842a65","topics":["0xfec331350fce78ba658e082a71da20ac9f8d798a99b3c79681c8440cbfe77e07"],"data":"0xb81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb000000000000000000000000000000000000000000000000a5953ec9be11bd73","blockNumber":"0x13ec371","transactionHash":"0x09b63a10295261192885b38af317ba138ad7fe5828ce25524e7f0f053e250458","transactionIndex":"0x7","blockHash":"0x291e59d96ccc8b661842cfd9c4dcce1d11ed30cd4cf2b8034bff2a8d7a595785","logIndex":"0x3e","removed":false}]`
	var events []types.Log
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0x5b93d80da1a359340d1f339fb574bdc56763f995", "gas": "0x7805c", "gasUsed": "0xaa29", "to": "0x111111125421ca6dc452d289314280a0f8842a65", "input": "0xf497df75e26b9977fabcf23097e49776cb360dda5656330c99a7c8f531e674118829d376000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000125195019f8400000000000000000000000000000000000000000000000000000000001299cd101824a000000000000000000000000000000000066ff91df00000000000000000000148038b763276eddd7894c7e298ed1d3d5f7a11f36404027b5a00f41928a899a80cf63d4895cd14df1cd15a6533e5dbb1675976f0c32004829ebcafdd3e9825800000000000000000000000000000000000000000000000002df3926958c42eba8000257000015000000000000000000000000000000000000000002f06464b800000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000028073a38006d23517a1d383c88929b2014f8835b38b000002370000018e0000018e0000009a0000009a0000004d0000000000000000fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc0030fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc003018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000111111125421ca6dc452d289314280a0f8842a65ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006700e0b9000000000000000000000000000000000000000000000000000000000000001c64498e3e35a5a54425bf9c1054eecb870749d1af47e06a8375f0273906f369e300997b5116afb64e6528c971d0b42fbcb839658ce392a85cdf681868ed0ff9abfb2809a5314473e1165f6b58018e20ed8f07b84066ff8f63b09498030ae3416b66dc0000b8394f2220fac7e6ade60000339fb574bdc56763f9950000d18bd45f0b94f54a968f0000d61b892b2ad6249011850000ade19567bb538035ed360000617556ed277ab322337800006de5e0e428ac771d77b5000006455390207c1d485be90000db05a6a504f04d92e79d00000cf7a62884e542b3bddd0000f7f4f96b98e102b56b040000605b93d80da1a359340d1f339fb574bdc56763f99503", "output": "0x00000000000000000000000000000000000000000000000002df3926958c42eb00000000000000000000000000000000000000000000000000000002f06464b8b81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb", "calls": [ { "from": "0x111111125421ca6dc452d289314280a0f8842a65", "gas": "0x73e61", "gasUsed": "0xabd", "to": "0xfb2809a5314473e1165f6b58018e20ed8f07b840", "input": "0xd7ff8a80e26b9977fabcf23097e49776cb360dda5656330c99a7c8f531e674118829d376000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000125195019f8400000000000000000000000000000000000000000000000000000000001299cd101824a000000000000000000000000000000000066ff91df0000000000000000000000000000000000000000000000000000000000000000000000000000000001c0b81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb0000000000000000000000005b93d80da1a359340d1f339fb574bdc56763f99500000000000000000000000000000000000000000000000002df3926958c42eb000000000000000000000000000000000000000000000000a87477f0539e005e00000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000257000002370000018e0000018e0000009a0000009a0000004d0000000000000000fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc0030fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc003018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000111111125421ca6dc452d289314280a0f8842a65ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006700e0b9000000000000000000000000000000000000000000000000000000000000001c64498e3e35a5a54425bf9c1054eecb870749d1af47e06a8375f0273906f369e300997b5116afb64e6528c971d0b42fbcb839658ce392a85cdf681868ed0ff9abfb2809a5314473e1165f6b58018e20ed8f07b84066ff8f63b09498030ae3416b66dc0000b8394f2220fac7e6ade60000339fb574bdc56763f9950000d18bd45f0b94f54a968f0000d61b892b2ad6249011850000ade19567bb538035ed360000617556ed277ab322337800006de5e0e428ac771d77b5000006455390207c1d485be90000db05a6a504f04d92e79d00000cf7a62884e542b3bddd0000f7f4f96b98e102b56b0400006000000000000000000000000000000000000000000000000000000000000000000000000000000000390000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc003000000000000000", "output": "0x00000000000000000000000000000000000000000000000000000002f06464b8", "type": "STATICCALL" }, { "from": "0x111111125421ca6dc452d289314280a0f8842a65", "gas": "0x722d3", "gasUsed": "0x2870", "to": "0x18084fba666a33d37592fa2633fd49a74dd93a88", "input": "0x23b872dd000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f800000000000000000000000073a38006d23517a1d383c88929b2014f8835b38b00000000000000000000000000000000000000000000000002df3926958c42eb", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0x18084fba666a33d37592fa2633fd49a74dd93a88", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8", "0x00000000000000000000000073a38006d23517a1d383c88929b2014f8835b38b" ], "data": "0x00000000000000000000000000000000000000000000000002df3926958c42eb", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0x111111125421ca6dc452d289314280a0f8842a65", "gas": "0x6f4d6", "gasUsed": "0x1d3", "to": "0x5b93d80da1a359340d1f339fb574bdc56763f995", "input": "0xadf38ba1e26b9977fabcf23097e49776cb360dda5656330c99a7c8f531e674118829d376000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000125195019f8400000000000000000000000000000000000000000000000000000000001299cd101824a000000000000000000000000000000000066ff91df0000000000000000000000000000000000000000000000000000000000000000000000000000000001e0b81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb0000000000000000000000005b93d80da1a359340d1f339fb574bdc56763f99500000000000000000000000000000000000000000000000002df3926958c42eb00000000000000000000000000000000000000000000000000000002f06464b8000000000000000000000000000000000000000000000000a87477f0539e005e00000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000000257000002370000018e0000018e0000009a0000009a0000004d0000000000000000fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc0030fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc003018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000111111125421ca6dc452d289314280a0f8842a65ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006700e0b9000000000000000000000000000000000000000000000000000000000000001c64498e3e35a5a54425bf9c1054eecb870749d1af47e06a8375f0273906f369e300997b5116afb64e6528c971d0b42fbcb839658ce392a85cdf681868ed0ff9abfb2809a5314473e1165f6b58018e20ed8f07b84066ff8f63b09498030ae3416b66dc0000b8394f2220fac7e6ade60000339fb574bdc56763f9950000d18bd45f0b94f54a968f0000d61b892b2ad6249011850000ade19567bb538035ed360000617556ed277ab322337800006de5e0e428ac771d77b5000006455390207c1d485be90000db05a6a504f04d92e79d00000cf7a62884e542b3bddd0000f7f4f96b98e102b56b0400006000000000000000000000000000000000000000000000000000000000000000000000000000000000010300000000000000000000000000000000000000000000000000000000000000", "value": "0x0", "type": "CALL" }, { "from": "0x111111125421ca6dc452d289314280a0f8842a65", "gas": "0x6ef4b", "gasUsed": "0x1e32", "to": "0xdac17f958d2ee523a2206206994597c13d831ec7", "input": "0x23b872dd0000000000000000000000005b93d80da1a359340d1f339fb574bdc56763f995000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f800000000000000000000000000000000000000000000000000000002f06464b8", "logs": [ { "address": "0xdac17f958d2ee523a2206206994597c13d831ec7", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x0000000000000000000000005b93d80da1a359340d1f339fb574bdc56763f995", "0x000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8" ], "data": "0x00000000000000000000000000000000000000000000000000000002f06464b8", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0x111111125421ca6dc452d289314280a0f8842a65", "gas": "0x6c9f6", "gasUsed": "0x7ff", "to": "0xfb2809a5314473e1165f6b58018e20ed8f07b840", "input": "0x462ebde2e26b9977fabcf23097e49776cb360dda5656330c99a7c8f531e674118829d376000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec700000000000000000000000000000000000000000000000125195019f8400000000000000000000000000000000000000000000000000000000001299cd101824a000000000000000000000000000000000066ff91df0000000000000000000000000000000000000000000000000000000000000000000000000000000001e0b81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb0000000000000000000000005b93d80da1a359340d1f339fb574bdc56763f99500000000000000000000000000000000000000000000000002df3926958c42eb00000000000000000000000000000000000000000000000000000002f06464b8000000000000000000000000000000000000000000000000a87477f0539e005e00000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000000257000002370000018e0000018e0000009a0000009a0000004d0000000000000000fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc0030fb2809a5314473e1165f6b58018e20ed8f07b8400000bc0000124b66ff8f7b00025801537c01456d0054013adf00540136850054011bb5005400c554005400c3db001800c2cb006c0000bc003018084fba666a33d37592fa2633fd49a74dd93a88000000000000000000000000a231659f41c77ef38b7da914276ffa37422783f8000000000000000000000000111111125421ca6dc452d289314280a0f8842a65ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000006700e0b9000000000000000000000000000000000000000000000000000000000000001c64498e3e35a5a54425bf9c1054eecb870749d1af47e06a8375f0273906f369e300997b5116afb64e6528c971d0b42fbcb839658ce392a85cdf681868ed0ff9abfb2809a5314473e1165f6b58018e20ed8f07b84066ff8f63b09498030ae3416b66dc0000b8394f2220fac7e6ade60000339fb574bdc56763f9950000d18bd45f0b94f54a968f0000d61b892b2ad6249011850000ade19567bb538035ed360000617556ed277ab322337800006de5e0e428ac771d77b5000006455390207c1d485be90000db05a6a504f04d92e79d00000cf7a62884e542b3bddd0000f7f4f96b98e102b56b04000060000000000000000000000000000000000000000000000000000000000000000000000000000000009566ff8f63b09498030ae3416b66dc0000b8394f2220fac7e6ade60000339fb574bdc56763f9950000d18bd45f0b94f54a968f0000d61b892b2ad6249011850000ade19567bb538035ed360000617556ed277ab322337800006de5e0e428ac771d77b5000006455390207c1d485be90000db05a6a504f04d92e79d00000cf7a62884e542b3bddd0000f7f4f96b98e102b56b040000600000000000000000000000", "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0x111111125421ca6dc452d289314280a0f8842a65", "topics": [ "0xfec331350fce78ba658e082a71da20ac9f8d798a99b3c79681c8440cbfe77e07" ], "data": "0xb81725973077ecc6db7dd73510be46152917f31ab7d02210aace851edc0f3fbb000000000000000000000000000000000000000000000000a5953ec9be11bd73", "position": "0x5" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	for _, event := range events {
		logs, err := p.ParseWithCallFrame(callFrame, event, uint64(time.Now().Unix()))
		require.NoError(t, err)
		log := logs[0]
		require.Equal(t, log.EventHash, p.eventHash)
		t.Log(log.Maker)
		t.Log(log.MakerToken)
		t.Log(log.MakerTokenAmount)
		t.Log(log.Taker)
		t.Log(log.TakerToken)
		t.Log(log.TakerTokenAmount)
	}
}

func TestDecodeMakerAssetSuffix(t *testing.T) {
	testcases := []struct {
		name          string // tx_hash
		takerTraits   string
		args          string
		expectedToken string
	}{
		{
			name:          "0x4cf66a97cb868795999cf308ab49256b3e64f098698923dd00ecd39724960569",
			takerTraits:   "18092523433231882371958174130396796232983432224281174865446760849707234230272",
			args:          "111111125421ca6dc452d289314280a0f8842a650000014000000140000001400000014000000140000001400000014000000140000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000001b76d81000000000000000000000000000000000000000000000000000000001308a5d9000000000000000000000000000000000000000000000000000000006710c6a6f4000a0f107a31c0a9a7a364baa04df5af91df0148e36494035431f0b0f5fcac00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000041c31117e0b33506fe565e81971b640e7e25681356a4be4fe767032c285bfe5d830bcbea9a206c0bd0c4c28657812e3e151b3646db73a10ebbf61e7cbb80da1b6d1b00000000000000000000000000000000000000000000000000000000000000",
			expectedToken: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
		},
		{
			name:          "0xcf0e8b8d7bdd2228d11d06d706e5d1590d0eb1b847cb08bb147279443fdd113b",
			takerTraits:   "43422042953894800120864327101047276075886241369890048249078107351438231339008",
			args:          "0000014000000140000001400000014000000140000001400000014000000140000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000005bf74cbe2467c00000000000000000000000000000000000000000000000000000000001308a5db000000000000000000000000000000000000000000000000000000006710c6f1323b6dbdf2fda4934a7f1a0b6c04f1cb59658353c537571dc33634644e6eddca00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000041fb57887615ac679372de0387fbe3851057b8dfcb5ffad0f319d1c4317c4b09ec3797f77ac06e0cebca0965f3ad104c7534b0ba0ed43b4d1c2e3d0e36ffded15b1c00000000000000000000000000000000000000000000000000000000000000",
			expectedToken: "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
		},
		{
			name:          "0x036a23820f8cf7878bae223b8531206244448e98f9d99b40ebdadb9965aceeaa",
			takerTraits:   "18092523433231882371958174130396796232983432224281174865446760849707234230272",
			args:          "111111125421ca6dc452d289314280a0f8842a650000014000000140000001400000014000000140000001400000014000000140000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000169a9b78de000000000000000000000000000000000000000000000000000000001308a5cc000000000000000000000000000000000000000000000000000000006710c385f67f22f4d926081dbb376db1b25c4d8602297e1bdd43c94536547e83e5c9405800000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000041b9effaad6be5cb9d18e4777b9abd08d3de5dd5a7f157462984f8b14e3d25933e3d9a1a41a18b6fe82ef256d70ed8fc9155a9201a12e66198f9a4942d0040fc751c00000000000000000000000000000000000000000000000000000000000000",
			expectedToken: "0xdac17f958d2ee523a2206206994597c13d831ec7",
		},
		{
			name:          "0x94ff859324334b7bab4b7674f9d12f26b2e0d29759b8d5992fc4c23d7855e412",
			takerTraits:   "14474020644565751264971580848875299112568745203479907239213711349459948929024",
			args:          "0000014000000140000001400000014000000140000001400000014000000140000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000010be2004c29abd0000000000000000000000000000000000000000000000000000000001308a5bd000000000000000000000000000000000000000000000000000000006710bfe863f5bfe22eb8c8c0524d14554798843e12d0ef5d4734b6aec98bedca85b49b3e0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000004164c0db9c346457aeaa6d6e8b635ae2a5b844b63d9a28232ca06697ca74db689272d03f00c07b260077eaeb8af9ade13e7fe051808fd1e03b6f9107e15f6066591c00000000000000000000000000000000000000000000000000000000000000",
			expectedToken: "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
		},
		{
			name:          "0xe60e1b81a2ee387092d51b279c4d6fcebe4ab864027b98399b0439c62da22143",
			takerTraits:   "43422042953894800120864327101047276075886241369890048249078107351438231339008",
			args:          "0000014000000140000001400000014000000140000001400000014000000140000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000001f6eced54faed40000000000000000000000000000000000000000000000000000000001308a565000000000000000000000000000000000000000000000000000000006710bd1769b8870c074a51878175bcc84a20ecee4ae13c5dc814df79bb930af2fde7c129000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000417c25f11f48119efec8508416371922fd3c94cda83ea4b79b1c1989678025ed783f0eeeb278f1a09631f5847d2ab51c08741568f8ed917f12c8e1f8ec83970f111b00000000000000000000000000000000000000000000000000000000000000",
			expectedToken: "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2",
		},
	}

	for _, tc := range testcases {
		t.Run(tc.name, func(t *testing.T) {
			takerTraits, _ := new(big.Int).SetString(tc.takerTraits, 10)
			args, _ := hex.DecodeString(tc.args)

			token, err := decodeMakerAssetSuffix(takerTraits, args)
			require.NoError(t, err)
			require.Equal(t, tc.expectedToken, strings.ToLower(token.Hex()))
		})
	}

}

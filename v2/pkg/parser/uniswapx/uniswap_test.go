package uniswapx // nolint: testpackage

import (
	"context"
	"encoding/json"
	"fmt"
	types2 "github.com/KyberNetwork/tradelogs/v2/pkg/types"
	"math/big"
	"os"
	"testing"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/require"
)

var rpcURL = os.Getenv("TEST_RPC_URL")

func TestFetchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	ethClient, err := ethclient.Dial(rpcURL)
	require.NoError(t, err)
	p := MustNewParser()
	require.Equal(t, p.abi.Events[FilledEvent].ID, common.HexToHash("0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66"))
	logs, err := ethClient.FilterLogs(context.Background(), ethereum.FilterQuery{
		BlockHash: nil,
		FromBlock: big.NewInt(21055318),
		ToBlock:   big.NewInt(21055318),
		Addresses: nil,
		Topics: [][]common.Hash{
			{
				p.abi.Events[FilledEvent].ID,
			},
		},
	})
	require.NoError(t, err)
	d, err := json.Marshal(logs)
	require.NoError(t, err)
	t.Log(string(d))
}

func TestParseEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")

	eventRaw := `{"address":"0x00000011f84b9aa48e5f8aa8b9897600006289be","topics":["0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66","0xa09fd699de09d6492bd94a552d1411802fcce905984e90fe5720039931546cfc","0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38","0x000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c"],"data":"0x046832975f1fff57796138f8a594ca97d887a6d4fef01f55f262cc210b31ba04","blockNumber":"0x13e94ae","transactionHash":"0xa0f1fb44e76f666e79bc4b290f226dac851e60c8eb57226012167b2cd313cc98","transactionIndex":"0x34","blockHash":"0xea65325c25577b35c89d5b7fee914f16ae9e3a4683fe7abf3ec5eeba0f17e128","logIndex":"0x11f","removed":false}`
	event := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &event)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0x807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "gas": "0x250b8", "gasUsed": "0x1b6b3", "to": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "input": "0x3f62192e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000420000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000025ff81b30000000000000000000000000000000000000000000000000000000025ff81b3000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000011f84b9aa48e5f8aa8b9897600006289be000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c046832975f1fff57796138f8a594ca97d887a6d4fef01f55f262cc210b31ba040000000000000000000000000000000000000000000000000000000066fd5e45000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000025ed8b5cf000000000000000000000000000000000000000000000000000000025d314fc0000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c0000000000000000000000000000000000000000000000000000000066fd5d340000000000000000000000000000000000000000000000000000000066fd5d70000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd380000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000025fb7bbba00000000000000000000000000000000000000000000000000000000000000410bb24f4692c2c4a5639a051d8c308723b6e6320346ac74154b11ab3cccc7f724490bb493a5c376c3ca01e2b31e1f946a762fc4634cc58b42a3708ea9ff5f7ed71c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412f8bf70f6a3a9ac43d3080c3ac0ddd62e3b91879f2f74e13de86ebd09cd221536c06402b81779ca9ad29595b983b18561eb482850770ec5d13933d23322760b21c00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x20a53", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0xd294ac31f83b8735ab645e751946090418c29f977400bb4c3e6dc51aa4163d59000000000000000000000000000000000000000000000000000000000000001c0bb24f4692c2c4a5639a051d8c308723b6e6320346ac74154b11ab3cccc7f724490bb493a5c376c3ca01e2b31e1f946a762fc4634cc58b42a3708ea9ff5f7ed7", "output": "0x0000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180", "type": "STATICCALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x1ceb0", "gasUsed": "0xbda0", "to": "0x000000000022d473030f116ddee9f6b43ac78ba3", "input": "0x137c29fe000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000025ff81b30046832975f1fff57796138f8a594ca97d887a6d4fef01f55f262cc210b31ba040000000000000000000000000000000000000000000000000000000066fd5e45000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38000000000000000000000000000000000000000000000000000000025ff81b30000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910ca09fd699de09d6492bd94a552d1411802fcce905984e90fe5720039931546cfc0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000001b8563244757463684f72646572207769746e6573732944757463684f7574707574286164647265737320746f6b656e2c75696e74323536207374617274416d6f756e742c75696e7432353620656e64416d6f756e742c6164647265737320726563697069656e74294f72646572496e666f28616464726573732072656163746f722c6164647265737320737761707065722c75696e74323536206e6f6e63652c75696e7432353620646561646c696e652c61646472657373206164646974696f6e616c56616c69646174696f6e436f6e74726163742c6279746573206164646974696f6e616c56616c69646174696f6e4461746129546f6b656e5065726d697373696f6e73286164647265737320746f6b656e2c75696e7432353620616d6f756e7429563244757463684f72646572284f72646572496e666f20696e666f2c6164647265737320636f7369676e65722c616464726573732062617365496e707574546f6b656e2c75696e743235362062617365496e7075745374617274416d6f756e742c75696e743235362062617365496e707574456e64416d6f756e742c44757463684f75747075745b5d20626173654f75747075747329000000000000000000000000000000000000000000000000000000000000000000000000000000412f8bf70f6a3a9ac43d3080c3ac0ddd62e3b91879f2f74e13de86ebd09cd221536c06402b81779ca9ad29595b983b18561eb482850770ec5d13933d23322760b21c00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x19c6f", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0xedf42225a1a2725b3e4c2f33979891a01a0281de6a519db037262fe8875fad26000000000000000000000000000000000000000000000000000000000000001c2f8bf70f6a3a9ac43d3080c3ac0ddd62e3b91879f2f74e13de86ebd09cd221536c06402b81779ca9ad29595b983b18561eb482850770ec5d13933d23322760b2", "output": "0x000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c", "type": "STATICCALL" }, { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x18600", "gasUsed": "0x7ad9", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x23b872dd000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38000000000000000000000000000000000000000000000000000000025ff81b30", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x16407", "gasUsed": "0x5e5a", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x23b872dd000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38000000000000000000000000000000000000000000000000000000025ff81b30", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c", "0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38" ], "data": "0x000000000000000000000000000000000000000000000000000000025ff81b30", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x107dc", "gasUsed": "0x67a2", "to": "0xdac17f958d2ee523a2206206994597c13d831ec7", "input": "0x23b872dd000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c000000000000000000000000000000000000000000000000000000025fb7bbba", "logs": [ { "address": "0xdac17f958d2ee523a2206206994597c13d831ec7", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "0x000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c" ], "data": "0x000000000000000000000000000000000000000000000000000000025fb7bbba", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "topics": [ "0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66", "0xa09fd699de09d6492bd94a552d1411802fcce905984e90fe5720039931546cfc", "0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "0x000000000000000000000000cf2828bb821e935292f1d3ff7f996e19efe4910c" ], "data": "0x046832975f1fff57796138f8a594ca97d887a6d4fef01f55f262cc210b31ba04", "position": "0x3" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	ethClient, err := ethclient.Dial(rpcURL)
	if err != nil {
		panic(err)
	}
	block, err := ethClient.BlockByHash(context.Background(), event.BlockHash)
	require.NoError(t, err)
	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, event, block.Time())
	require.NoError(t, err)
	fmt.Printf("%+v\n", logs)
	log := logs[0]
	require.Equal(t, log.EventHash, p.eventHash)
	require.Equal(t, log.Maker, "0x807cF9A772d5a3f9CeFBc1192e939D62f0D9bD38")
	require.Equal(t, log.Taker, "0xcF2828bb821E935292f1D3Ff7F996e19eFe4910c")
	require.Equal(t, log.MakerTokenAmount, "10195811258")
	require.Equal(t, log.TakerTokenAmount, "10200030000")
	require.Equal(t, log.Expiry, uint64(0x66fd5e45))
	t.Log(log)
}

func TestParseBatchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `[{"address":"0x00000011f84b9aa48e5f8aa8b9897600006289be","topics":["0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66","0x1d62255d2fd90374be846f2114e2540a8b80242c4f849fd6dfb58a316479e9ca","0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8","0x0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf"],"data":"0x046832f5aa4b6a391a75b577e69c7409cf31d676a3983732f7cce4a8100f4001","blockNumber":"0x1414756","transactionHash":"0xe2530de46bf952c22a0c094586b6c2408a6b4900f07488f838a76874bde6cbf7","transactionIndex":"0x15","blockHash":"0x81279855a5a4d20e4369dc27928e08d8076ff342c4af02710862672c853659e4","logIndex":"0xa7","removed":false},{"address":"0x00000011f84b9aa48e5f8aa8b9897600006289be","topics":["0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66","0x7a70f8eb7d8a241a9016a9bee57b5166fa1aab9bdfe22bdf2a08d32b0ac4dd13","0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8","0x00000000000000000000000085e3d047e92feb7879c302b92b689d7538b34691"],"data":"0x0468321cf5cd8349ef1d43cbdc795973c2c38a7392e7bc6e246e42051702840f","blockNumber":"0x1414756","transactionHash":"0xe2530de46bf952c22a0c094586b6c2408a6b4900f07488f838a76874bde6cbf7","transactionIndex":"0x15","blockHash":"0x81279855a5a4d20e4369dc27928e08d8076ff342c4af02710862672c853659e4","logIndex":"0xa8","removed":false}]`
	var events []types.Log
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x6a775", "gasUsed": "0x55f27", "to": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "input": "0x13fb72c700000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000be00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca00000000000000000000000000000000000000000000000d0b97e8171773200000000000000000000000000000000000000000000000000d0b97e8171773200000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000011f84b9aa48e5f8aa8b9897600006289be0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf046832f5aa4b6a391a75b577e69c7409cf31d676a3983732f7cce4a8100f400100000000000000000000000000000000000000000000000000000000671de565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eab28eb849ab3bf0000000000000000000000000000000000000000000000000e8cacc8ed1658bd0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000969535b70ab1d000000000000000000000000000000000000000000000000000955c4315b29ed000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c00000000000000000000000000000000000000000000000000000000671de46600000000000000000000000000000000000000000000000000000000671de4a200000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a80000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000eb5052037e70fe3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000417fed3e8bfe12d21b844d90d8103b2fd565c0f9150d56f1e64b41f03433ca28a815cab69bb084b71b282a192897c33917aef7b3de7cdd26240adf3d3149fe3d6a1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041ae6f9cad141d34e2f3724eae4d763a4f4a20f16c419260255daa20e8d52cd9d47bc7199dcb8904200fb5671b8937178b2aeb3dcd11cc1d9ea8659e250af960f61b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001000000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180000000000000000000000000faba6f8e4a5e8ab82f62fe7c39859fa577269be3000000000000000000000000000000000000000000000017da3a04c7b3e00000000000000000000000000000000000000000000000000017da3a04c7b3e0000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000011f84b9aa48e5f8aa8b9897600006289be00000000000000000000000085e3d047e92feb7879c302b92b689d7538b346910468321cf5cd8349ef1d43cbdc795973c2c38a7392e7bc6e246e42051702840f00000000000000000000000000000000000000000000000000000000671de56b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a979a52698bfde00000000000000000000000000000000000000000000000001a212693764116400000000000000000000000085e3d047e92feb7879c302b92b689d7538b346910000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110fc9075279e00000000000000000000000000000000000000000000000000010c3c9310eeb8000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c00000000000000000000000000000000000000000000000000000000671de46a00000000000000000000000000000000000000000000000000000000671de4a600000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a80000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000001aa2e88cd08535e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000415aae60f4a5526aab289d604f7dd7681d4e99175732ccaad4248b01e63c26df1d2532ace5cff2b2c27f5130e7f2c52c4f74b3c5423f5a163ffc5941fd1170d5dd1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041605336e71fa12014682cd540a564edb3e7bdcf9c141b84dac1b7614b020bd159754ac485f1cfa76d0443fd6f4364fba6a2bd31de967554edc8f9f877abede0681b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x6470e", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x64e701912ce18d6b95af943d029c02c0b9dc5235fb2037ea2c09bb7394afb4d4000000000000000000000000000000000000000000000000000000000000001b7fed3e8bfe12d21b844d90d8103b2fd565c0f9150d56f1e64b41f03433ca28a815cab69bb084b71b282a192897c33917aef7b3de7cdd26240adf3d3149fe3d6a", "output": "0x0000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180", "type": "STATICCALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x5fffc", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x2f9ba1540846977abf11fc295661f1ed9398c6a983607abaf0f793312166ff2c000000000000000000000000000000000000000000000000000000000000001b5aae60f4a5526aab289d604f7dd7681d4e99175732ccaad4248b01e63c26df1d2532ace5cff2b2c27f5130e7f2c52c4f74b3c5423f5a163ffc5941fd1170d5dd", "output": "0x0000000000000000000000004449cd34d1eb1fedcf02a1be3834ffde8e6a6180", "type": "STATICCALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x5bffd", "gasUsed": "0x1116b", "to": "0x000000000022d473030f116ddee9f6b43ac78ba3", "input": "0x137c29fe000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca00000000000000000000000000000000000000000000000d0b97e81717732000046832f5aa4b6a391a75b577e69c7409cf31d676a3983732f7cce4a8100f400100000000000000000000000000000000000000000000000000000000671de56500000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a800000000000000000000000000000000000000000000000d0b97e817177320000000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf1d62255d2fd90374be846f2114e2540a8b80242c4f849fd6dfb58a316479e9ca0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000001b8563244757463684f72646572207769746e6573732944757463684f7574707574286164647265737320746f6b656e2c75696e74323536207374617274416d6f756e742c75696e7432353620656e64416d6f756e742c6164647265737320726563697069656e74294f72646572496e666f28616464726573732072656163746f722c6164647265737320737761707065722c75696e74323536206e6f6e63652c75696e7432353620646561646c696e652c61646472657373206164646974696f6e616c56616c69646174696f6e436f6e74726163742c6279746573206164646974696f6e616c56616c69646174696f6e4461746129546f6b656e5065726d697373696f6e73286164647265737320746f6b656e2c75696e7432353620616d6f756e7429563244757463684f72646572284f72646572496e666f20696e666f2c6164647265737320636f7369676e65722c616464726573732062617365496e707574546f6b656e2c75696e743235362062617365496e7075745374617274416d6f756e742c75696e743235362062617365496e707574456e64416d6f756e742c44757463684f75747075745b5d20626173654f7574707574732900000000000000000000000000000000000000000000000000000000000000000000000000000041ae6f9cad141d34e2f3724eae4d763a4f4a20f16c419260255daa20e8d52cd9d47bc7199dcb8904200fb5671b8937178b2aeb3dcd11cc1d9ea8659e250af960f61b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x53c36", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x964675920b835a1b01e9b6abdaa9dfa47ac01154a770e179a29fe28471f57540000000000000000000000000000000000000000000000000000000000000001bae6f9cad141d34e2f3724eae4d763a4f4a20f16c419260255daa20e8d52cd9d47bc7199dcb8904200fb5671b8937178b2aeb3dcd11cc1d9ea8659e250af960f6", "output": "0x0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf", "type": "STATICCALL" }, { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x525c7", "gasUsed": "0x8bd8", "to": "0x514910771af9ca656af840dff83e8264ecf986ca", "input": "0x23b872dd0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a800000000000000000000000000000000000000000000000d0b97e81717732000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0x514910771af9ca656af840dff83e8264ecf986ca", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8" ], "data": "0x00000000000000000000000000000000000000000000000d0b97e81717732000", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x49f15", "gasUsed": "0x17c2c", "to": "0x000000000022d473030f116ddee9f6b43ac78ba3", "input": "0x137c29fe000000000000000000000000faba6f8e4a5e8ab82f62fe7c39859fa577269be3000000000000000000000000000000000000000000000017da3a04c7b3e000000468321cf5cd8349ef1d43cbdc795973c2c38a7392e7bc6e246e42051702840f00000000000000000000000000000000000000000000000000000000671de56b00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8000000000000000000000000000000000000000000000017da3a04c7b3e0000000000000000000000000000085e3d047e92feb7879c302b92b689d7538b346917a70f8eb7d8a241a9016a9bee57b5166fa1aab9bdfe22bdf2a08d32b0ac4dd130000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000001b8563244757463684f72646572207769746e6573732944757463684f7574707574286164647265737320746f6b656e2c75696e74323536207374617274416d6f756e742c75696e7432353620656e64416d6f756e742c6164647265737320726563697069656e74294f72646572496e666f28616464726573732072656163746f722c6164647265737320737761707065722c75696e74323536206e6f6e63652c75696e7432353620646561646c696e652c61646472657373206164646974696f6e616c56616c69646174696f6e436f6e74726163742c6279746573206164646974696f6e616c56616c69646174696f6e4461746129546f6b656e5065726d697373696f6e73286164647265737320746f6b656e2c75696e7432353620616d6f756e7429563244757463684f72646572284f72646572496e666f20696e666f2c6164647265737320636f7369676e65722c616464726573732062617365496e707574546f6b656e2c75696e743235362062617365496e7075745374617274416d6f756e742c75696e743235362062617365496e707574456e64416d6f756e742c44757463684f75747075745b5d20626173654f7574707574732900000000000000000000000000000000000000000000000000000000000000000000000000000041605336e71fa12014682cd540a564edb3e7bdcf9c141b84dac1b7614b020bd159754ac485f1cfa76d0443fd6f4364fba6a2bd31de967554edc8f9f877abede0681b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x46192", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0xf1676cc9d78e90fb58db3ab3b3a290d4a8927773949de0acdb32ce45259ce127000000000000000000000000000000000000000000000000000000000000001b605336e71fa12014682cd540a564edb3e7bdcf9c141b84dac1b7614b020bd159754ac485f1cfa76d0443fd6f4364fba6a2bd31de967554edc8f9f877abede068", "output": "0x00000000000000000000000085e3d047e92feb7879c302b92b689d7538b34691", "type": "STATICCALL" }, { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x44b23", "gasUsed": "0x13965", "to": "0xfaba6f8e4a5e8ab82f62fe7c39859fa577269be3", "input": "0x23b872dd00000000000000000000000085e3d047e92feb7879c302b92b689d7538b3469100000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8000000000000000000000000000000000000000000000017da3a04c7b3e00000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xfaba6f8e4a5e8ab82f62fe7c39859fa577269be3", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000085e3d047e92feb7879c302b92b689d7538b34691", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8" ], "data": "0x000000000000000000000000000000000000000000000017da3a04c7b3e00000", "position": "0x0" }, { "address": "0xfaba6f8e4a5e8ab82f62fe7c39859fa577269be3", "topics": [ "0xdec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a724", "0x000000000000000000000000f3feafa241ebf6781057de4406ed486fa91b1585" ], "data": "0x000000000000000000000000000000000000000000000100174e94f527eada240000000000000000000000000000000000000000000000e83d14902d740ada24", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x319c2", "gasUsed": "0x14f50", "to": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "input": "0x585da628000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000006e000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000514910771af9ca656af840dff83e8264ecf986ca00000000000000000000000000000000000000000000000d0b97e8171773200000000000000000000000000000000000000000000000000d0b97e8171773200000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002a01d62255d2fd90374be846f2114e2540a8b80242c4f849fd6dfb58a316479e9ca00000000000000000000000000000011f84b9aa48e5f8aa8b9897600006289be0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf046832f5aa4b6a391a75b577e69c7409cf31d676a3983732f7cce4a8100f400100000000000000000000000000000000000000000000000000000000671de565000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eb5052037e70fe30000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000969535b70ab1d000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c0000000000000000000000000000000000000000000000000000000000000041ae6f9cad141d34e2f3724eae4d763a4f4a20f16c419260255daa20e8d52cd9d47bc7199dcb8904200fb5671b8937178b2aeb3dcd11cc1d9ea8659e250af960f61b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000faba6f8e4a5e8ab82f62fe7c39859fa577269be3000000000000000000000000000000000000000000000017da3a04c7b3e00000000000000000000000000000000000000000000000000017da3a04c7b3e0000000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002a07a70f8eb7d8a241a9016a9bee57b5166fa1aab9bdfe22bdf2a08d32b0ac4dd1300000000000000000000000000000011f84b9aa48e5f8aa8b9897600006289be00000000000000000000000085e3d047e92feb7879c302b92b689d7538b346910468321cf5cd8349ef1d43cbdc795973c2c38a7392e7bc6e246e42051702840f00000000000000000000000000000000000000000000000000000000671de56b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001aa2e88cd08535e00000000000000000000000085e3d047e92feb7879c302b92b689d7538b346910000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110fc9075279e000000000000000000000000000000fee13a103a10d593b9ae06b3e05f2e7e1c0000000000000000000000000000000000000000000000000000000000000041605336e71fa12014682cd540a564edb3e7bdcf9c141b84dac1b7614b020bd159754ac485f1cfa76d0443fd6f4364fba6a2bd31de967554edc8f9f877abede0681b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x2e6a2", "gasUsed": "0x2161", "to": "0x514910771af9ca656af840dff83e8264ecf986ca", "input": "0xa9059cbb000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec600000000000000000000000000000000000000000000000d0b97e81717732000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0x514910771af9ca656af840dff83e8264ecf986ca", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8", "0x000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec6" ], "data": "0x00000000000000000000000000000000000000000000000d0b97e81717732000", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x2c1c0", "gasUsed": "0x36ad", "to": "0xfaba6f8e4a5e8ab82f62fe7c39859fa577269be3", "input": "0xa9059cbb000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec6000000000000000000000000000000000000000000000017da3a04c7b3e00000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xfaba6f8e4a5e8ab82f62fe7c39859fa577269be3", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8", "0x000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec6" ], "data": "0x000000000000000000000000000000000000000000000017da3a04c7b3e00000", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x27e97", "gasUsed": "0x7d7d", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec600000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a80000000000000000000000000000000000000000000000001069adf8f0d535fc", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000ff8ba4d1fc3762f6154cc942ccf30049a2a0cec6", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8" ], "data": "0x0000000000000000000000000000000000000000000000001069adf8f0d535fc", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x2017d", "gasUsed": "0x23eb", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x2e1a7d4d0000000000000000000000000000000000000000000000001069adf8f0d535fc", "calls": [ { "from": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "gas": "0x8fc", "gasUsed": "0x37", "to": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "input": "0x", "value": "0x1069adf8f0d535fc", "type": "CALL" } ], "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8" ], "data": "0x0000000000000000000000000000000000000000000000001069adf8f0d535fc", "position": "0x1" } ], "value": "0x0", "type": "CALL" }, { "from": "0x43ee35d5542f5b826fa92832bd97caff153675a8", "gas": "0x1c3d6", "gasUsed": "0x37", "to": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "input": "0x", "value": "0x1069adf8f0d535fc", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x1b403", "gasUsed": "0x0", "to": "0x2d2e4848fa164911f935e713c58a3ce251f95ddf", "input": "0x", "value": "0xeb5052037e70fe3", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x18ec7", "gasUsed": "0x37", "to": "0x000000fee13a103a10d593b9ae06b3e05f2e7e1c", "input": "0x", "value": "0x969535b70ab1d", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x16974", "gasUsed": "0x0", "to": "0x85e3d047e92feb7879c302b92b689d7538b34691", "input": "0x", "value": "0x1aa2e88cd08535e", "type": "CALL" }, { "from": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "gas": "0x14dd4", "gasUsed": "0x37", "to": "0x000000fee13a103a10d593b9ae06b3e05f2e7e1c", "input": "0x", "value": "0x110fc9075279e", "type": "CALL" } ], "logs": [ { "address": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "topics": [ "0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66", "0x1d62255d2fd90374be846f2114e2540a8b80242c4f849fd6dfb58a316479e9ca", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8", "0x0000000000000000000000002d2e4848fa164911f935e713c58a3ce251f95ddf" ], "data": "0x046832f5aa4b6a391a75b577e69c7409cf31d676a3983732f7cce4a8100f4001", "position": "0x7" }, { "address": "0x00000011f84b9aa48e5f8aa8b9897600006289be", "topics": [ "0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66", "0x7a70f8eb7d8a241a9016a9bee57b5166fa1aab9bdfe22bdf2a08d32b0ac4dd13", "0x00000000000000000000000043ee35d5542f5b826fa92832bd97caff153675a8", "0x00000000000000000000000085e3d047e92feb7879c302b92b689d7538b34691" ], "data": "0x0468321cf5cd8349ef1d43cbdc795973c2c38a7392e7bc6e246e42051702840f", "position": "0x9" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	ethClient, err := ethclient.Dial(rpcURL)
	if err != nil {
		panic(err)
	}
	block, err := ethClient.BlockByHash(context.Background(), events[0].BlockHash)
	require.NoError(t, err)

	p := MustNewParser()
	for _, e := range events {
		logs, err := p.ParseWithCallFrame(callFrame, e, block.Time())
		require.NoError(t, err)
		log := logs[0]
		require.Equal(t, log.EventHash, p.eventHash)
		t.Log("maker", log.Maker)
		t.Log("maker_token", log.MakerToken)
		t.Log("taker", log.Taker)
		t.Log("taker_token", log.TakerToken)
		t.Log("maker_amount", log.MakerTokenAmount)
		t.Log("taker_amount", log.TakerTokenAmount)
		t.Log("------------------------")
	}
}

package cowprotocol // nolint: testpackage

import (
	"context"
	"encoding/json"
	"fmt"
	"math/big"
	"os"
	"testing"

	types2 "github.com/KyberNetwork/tradelogs/v2/pkg/types"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/require"
)

var rpcURL = os.Getenv("TEST_RPC_URL")

func TestFetchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	ethClient, err := ethclient.Dial(rpcURL)
	require.NoError(t, err)
	p := MustNewParser()
	require.Equal(t, p.abi.Events[TradeEvent].ID, common.HexToHash("0xa07a543ab8a018198e99ca0184c93fe9050a79400a0a723441f84de1d972cc17"))
	logs, err := ethClient.FilterLogs(context.Background(), ethereum.FilterQuery{
		BlockHash: nil,
		FromBlock: big.NewInt(22185932),
		ToBlock:   big.NewInt(22185932),
		Addresses: nil,
		Topics: [][]common.Hash{
			{
				p.abi.Events[TradeEvent].ID,
			},
		},
	})
	require.NoError(t, err)
	d, err := json.Marshal(logs)
	require.NoError(t, err)
	t.Log(string(d))
}

func TestParseEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")

	eventRaw := `{"address":"0x9008d19f58aabd9ed0d60971565aa8510560ab41","topics":["0xa07a543ab8a018198e99ca0184c93fe9050a79400a0a723441f84de1d972cc17","0x0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d"],"data":"0x000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000051dac207a000000000000000000000000000000000000000000000000000000000032cfab47b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000038d3ad598dc57f26efad0ae780014475aeded181245a35c33dce21ae7dbcb405d30cde8a2ec22ff9073dce5fcf35dafe0963afff8d67ee12000000000000000000","blockNumber":"0x15287cc","transactionHash":"0x71bea1574fcd04ad16ec5223a66fa00ecfcc759fa32d0ac5ee4b176b0f6ad909","transactionIndex":"0x19","blockHash":"0x247bd9fd838c3a7ca6acbd83ed4f118dfff714320b0021cb07e240e91442b5fe","logIndex":"0x28","removed":false}`
	event := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &event)
	require.NoError(t, err)

	callFrameRaw := `{
		"from": "0x9dfc9bb0fff2dc96728d2bb94eacee6ba3592351",
		"gas": "0xaae60",
		"gasUsed": "0x3880b",
		"to": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
		"input": "0x13d79a0b0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000c097ce7bc90715b34b9f10000000000000000000000000000000000000000000000778f569a36dde80000000000000000000000000000000000000000000000000000000000000000000032cfab47b000000000000000000000000000000000000000000000000000051dac207a00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d000000000000000000000000000000000000000000000000000051dac207a00000000000000000000000000000000000000000000000000000000003291b494f0000000000000000000000000000000000000000000000000000000067ee1200c38ba9abdb3bfd3bd5af820b0f5294c179238e8bf49f66530d7ab4d942b1443200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000051dac207a000000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000417f010d6864c94815d39dfb3cd83f0d5368478f8c9ff34d422b4ac43a3b459fd1228a6e30e1f4335e0bac2427d0b063d195ce47ca17e61072c31483f1d36e1e2a1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000002644dcebcba0000000000000000000000000000000000000000000000000000000067ee0b440000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab4100000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000004c176b9c399000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000051d964b473d4000000000000000000000000000000000000000000000000000000032cfab47b0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000041f046a448d765d2bbb49718d812cd599f76d18ed2dab77c60e4f2d05065aa932669d5c2bc5bc0a9dd54491029d64104cf4738680acb93c95764fa2e20d22be92a1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009f582c",
		"calls": [
			{
				"from": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"gas": "0x9db20",
				"gasUsed": "0x1cc5",
				"to": "0x2c4c28ddbdac9c5e7055b4c863b72ea0149d8afe",
				"input": "0x02cc250d0000000000000000000000009dfc9bb0fff2dc96728d2bb94eacee6ba3592351",
				"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
				"calls": [
					{
						"from": "0x2c4c28ddbdac9c5e7055b4c863b72ea0149d8afe",
						"gas": "0x9a0ec",
						"gasUsed": "0x97f",
						"to": "0x9e7ae8bdba9aa346739792d219a808884996db67",
						"input": "0x02cc250d0000000000000000000000009dfc9bb0fff2dc96728d2bb94eacee6ba3592351",
						"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
						"value": "0x0",
						"type": "DELEGATECALL"
					}
				],
				"type": "STATICCALL"
			},
			{
				"from": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"gas": "0x9b0c1",
				"gasUsed": "0xbb8",
				"to": "0x0000000000000000000000000000000000000001",
				"input": "0xd3ad598dc57f26efad0ae780014475aeded181245a35c33dce21ae7dbcb405d3000000000000000000000000000000000000000000000000000000000000001b7f010d6864c94815d39dfb3cd83f0d5368478f8c9ff34d422b4ac43a3b459fd1228a6e30e1f4335e0bac2427d0b063d195ce47ca17e61072c31483f1d36e1e2a",
				"output": "0x0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d",
				"type": "STATICCALL"
			},
			{
				"from": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"gas": "0x929ac",
				"gasUsed": "0x82cf",
				"to": "0xc92e8bdf79f0507f65a392b0ab4667716bfe0110",
				"input": "0x7d10d11f000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000000000000000000000000000000051dac207a0005a28e9363bb942b639270062aa6bb295f434bcdfc42c97267bf003f272060dc9",
				"calls": [
					{
						"from": "0xc92e8bdf79f0507f65a392b0ab4667716bfe0110",
						"gas": "0x8f508",
						"gasUsed": "0x716d",
						"to": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
						"input": "0x23b872dd0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41000000000000000000000000000000000000000000000000000051dac207a000",
						"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
						"calls": [
							{
								"from": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
								"gas": "0x8be7e",
								"gasUsed": "0x5e42",
								"to": "0x8d92a6812b3da2346883f0631910c96cb9c5a5f9",
								"input": "0x23b872dd0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41000000000000000000000000000000000000000000000000000051dac207a000",
								"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
								"logs": [
									{
										"address": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
										"topics": [
											"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
											"0x0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d",
											"0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41"
										],
										"data": "0x000000000000000000000000000000000000000000000000000051dac207a000",
										"position": "0x0"
									}
								],
								"value": "0x0",
								"type": "DELEGATECALL"
							}
						],
						"value": "0x0",
						"type": "CALL"
					}
				],
				"value": "0x0",
				"type": "CALL"
			},
			{
				"from": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"gas": "0x89b03",
				"gasUsed": "0x1727a",
				"to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f",
				"input": "0x4dcebcba0000000000000000000000000000000000000000000000000000000067ee0b440000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab4100000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000004c176b9c399000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000051d964b473d4000000000000000000000000000000000000000000000000000000032cfab47b0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000041f046a448d765d2bbb49718d812cd599f76d18ed2dab77c60e4f2d05065aa932669d5c2bc5bc0a9dd54491029d64104cf4738680acb93c95764fa2e20d22be92a1c00000000000000000000000000000000000000000000000000000000000000",
				"calls": [
					{
						"from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f",
						"gas": "0x862ee",
						"gasUsed": "0x2b4b",
						"to": "0x51c72848c68a965f66fa7a88855f9f7784502a7f",
						"input": "0x1626ba7ee1d7ab8de1b55b25e4c6ded7b06ae6ca4df39e710fa09d618c21af54b1cf664400000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000041f046a448d765d2bbb49718d812cd599f76d18ed2dab77c60e4f2d05065aa932669d5c2bc5bc0a9dd54491029d64104cf4738680acb93c95764fa2e20d22be92a1c00000000000000000000000000000000000000000000000000000000000000",
						"output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000",
						"calls": [
							{
								"from": "0x51c72848c68a965f66fa7a88855f9f7784502a7f",
								"gas": "0x823cd",
								"gasUsed": "0xbb8",
								"to": "0x0000000000000000000000000000000000000001",
								"input": "0xe1d7ab8de1b55b25e4c6ded7b06ae6ca4df39e710fa09d618c21af54b1cf6644000000000000000000000000000000000000000000000000000000000000001cf046a448d765d2bbb49718d812cd599f76d18ed2dab77c60e4f2d05065aa932669d5c2bc5bc0a9dd54491029d64104cf4738680acb93c95764fa2e20d22be92a",
								"output": "0x000000000000000000000000a0f1898fb62aee04f9aa1aa5866bc48e6b4cb1d8",
								"type": "STATICCALL"
							}
						],
						"type": "STATICCALL"
					},
					{
						"from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f",
						"gas": "0x7da08",
						"gasUsed": "0x3d79",
						"to": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
						"input": "0x23b872dd0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab4100000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000051d964b473d4",
						"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
						"calls": [
							{
								"from": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
								"gas": "0x7b938",
								"gasUsed": "0x3be2",
								"to": "0x8d92a6812b3da2346883f0631910c96cb9c5a5f9",
								"input": "0x23b872dd0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab4100000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000051d964b473d4",
								"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
								"logs": [
									{
										"address": "0xd1d2eb1b1e90b638588728b4130137d262c87cae",
										"topics": [
											"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
											"0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
											"0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f"
										],
										"data": "0x000000000000000000000000000000000000000000000000000051d964b473d4",
										"position": "0x0"
									}
								],
								"value": "0x0",
								"type": "DELEGATECALL"
							}
						],
						"value": "0x0",
						"type": "CALL"
					},
					{
						"from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f",
						"gas": "0x78b8d",
						"gasUsed": "0x7ad9",
						"to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
						"input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41000000000000000000000000000000000000000000000000000000032cfab47b",
						"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
						"calls": [
							{
								"from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
								"gas": "0x7517e",
								"gasUsed": "0x5e5a",
								"to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd",
								"input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41000000000000000000000000000000000000000000000000000000032cfab47b",
								"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
								"logs": [
									{
										"address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
										"topics": [
											"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
											"0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f",
											"0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41"
										],
										"data": "0x000000000000000000000000000000000000000000000000000000032cfab47b",
										"position": "0x0"
									}
								],
								"value": "0x0",
								"type": "DELEGATECALL"
							}
						],
						"value": "0x0",
						"type": "CALL"
					}
				],
				"logs": [
					{
						"address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f",
						"topics": [
							"0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e",
							"0x0000000000000000000000000000000000000000000000000000000000000000"
						],
						"data": "0x",
						"position": "0x3"
					}
				],
				"value": "0x0",
				"type": "CALL"
			},
			{
				"from": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"gas": "0x722af",
				"gasUsed": "0x280c",
				"to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
				"input": "0xa9059cbb0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d000000000000000000000000000000000000000000000000000000032cfab47b",
				"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
				"calls": [
					{
						"from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
						"gas": "0x70347",
						"gasUsed": "0x24f7",
						"to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd",
						"input": "0xa9059cbb0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d000000000000000000000000000000000000000000000000000000032cfab47b",
						"output": "0x0000000000000000000000000000000000000000000000000000000000000001",
						"logs": [
							{
								"address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
								"topics": [
									"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
									"0x0000000000000000000000009008d19f58aabd9ed0d60971565aa8510560ab41",
									"0x0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d"
								],
								"data": "0x000000000000000000000000000000000000000000000000000000032cfab47b",
								"position": "0x0"
							}
						],
						"value": "0x0",
						"type": "DELEGATECALL"
					}
				],
				"value": "0x0",
				"type": "CALL"
			}
		],
		"logs": [
			{
				"address": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"topics": [
					"0xa07a543ab8a018198e99ca0184c93fe9050a79400a0a723441f84de1d972cc17",
					"0x0000000000000000000000000cde8a2ec22ff9073dce5fcf35dafe0963afff8d"
				],
				"data": "0x000000000000000000000000d1d2eb1b1e90b638588728b4130137d262c87cae000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000051dac207a000000000000000000000000000000000000000000000000000000000032cfab47b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000038d3ad598dc57f26efad0ae780014475aeded181245a35c33dce21ae7dbcb405d30cde8a2ec22ff9073dce5fcf35dafe0963afff8d67ee12000000000000000000",
				"position": "0x2"
			},
			{
				"address": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"topics": [
					"0xed99827efb37016f2275f98c4bcf71c7551c75d59e9b450f79fa32e60be672c2",
					"0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f"
				],
				"data": "0x00000000000000000000000000000000000000000000000000000000000000004dcebcba00000000000000000000000000000000000000000000000000000000",
				"position": "0x4"
			},
			{
				"address": "0x9008d19f58aabd9ed0d60971565aa8510560ab41",
				"topics": [
					"0x40338ce1a7c49204f0099533b1e9a7ee0a3d261f84974ab7af36105b8c4e9db4",
					"0x0000000000000000000000009dfc9bb0fff2dc96728d2bb94eacee6ba3592351"
				],
				"data": "0x",
				"position": "0x5"
			}
		],
		"value": "0x0",
		"type": "CALL"
	}`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	ethClient, err := ethclient.Dial(rpcURL)
	if err != nil {
		panic(err)
	}
	block, err := ethClient.BlockByHash(context.Background(), event.BlockHash)
	require.NoError(t, err)
	p := MustNewParser()

	logs, err := p.ParseWithCallFrame(callFrame, event, block.Time())
	require.NoError(t, err)
	fmt.Printf("%+v\n", logs)
	log := logs[0]
	require.Equal(t, log.EventHash, p.tradeEventHash)
	t.Log("owner", log.Owner)
	t.Log("sell token", log.SellToken)
	t.Log("sell amount", log.SellAmount)
	t.Log("buy token", log.BuyToken)
	t.Log("buy amount", log.BuyAmount)
	t.Log("contract", log.ContractAddress)
	t.Log("------------------------")
}

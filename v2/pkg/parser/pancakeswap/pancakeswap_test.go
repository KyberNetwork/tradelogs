package pancakeswap

import (
	"context"
	"encoding/json"
	"fmt"
	types2 "github.com/KyberNetwork/tradelogs/v2/pkg/types"
	"math/big"
	"os"
	"testing"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/stretchr/testify/assert"
)

var rpcURL = os.Getenv("TEST_RPC_URL")

func TestFetchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	ethClient, err := ethclient.Dial(rpcURL)
	if err != nil {
		panic(err)
	}

	p := MustNewParser()
	assert.Equal(t, p.abi.Events[FilledEvent].ID, common.HexToHash("0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66"))
	logs, err := ethClient.FilterLogs(context.Background(), ethereum.FilterQuery{
		BlockHash: nil,
		FromBlock: big.NewInt(20827954),
		ToBlock:   big.NewInt(20827954),
		Addresses: nil,
		Topics: [][]common.Hash{
			{
				p.abi.Events[FilledEvent].ID,
			},
		},
	})
	assert.NoError(t, err)
	d, err := json.Marshal(logs)
	assert.NoError(t, err)
	t.Log(string(d))
}

func TestParseEvent(t *testing.T) {
	event := types.Log{}
	eventRaw := `{"address":"0x35db01d1425685789dcc9228d47c7a5c049388d8","topics":["0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66","0x7cd33c73177739d79731891669df1b5f27319d0c9e7f6a24d4903968dbde68c9","0x000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16","0x0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4"],"data":"0x000468328d3deca81b41ae49eac5f79318c11f665cc8ac1a5f5dbbadefbc8b30","blockNumber":"0x13dcf32","transactionHash":"0x3db95e8b739ddfb2f2d967e3664a176c7ce13b2c9eeb8feaa4efb0a837245045","transactionIndex":"0xa3","blockHash":"0xb7e22e4a7d9800bce6f87ad4f1ea83aa7191f322aa7314ea732dffd12e29dcd7","logIndex":"0x204","removed":false}`
	err := json.Unmarshal([]byte(eventRaw), &event)
	assert.NoError(t, err)

	var callFrame types2.CallFrame
	callFrameRaw := `{ "from": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "gas": "0x3fc36", "gasUsed": "0x32da3", "to": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "input": "0x0d335884000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000066f411870000000000000000000000000000000000000000000000000000000066f411ff000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae160000000000000000000000000000000000000000000000000000000000000064000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000711be03000000000000000000000000000000000000000000000000000000000711be03000000000000000000000000000000000000000000000000000000000000020000000000000000000000000035db01d1425685789dcc9228d47c7a5c049388d80000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4000468328d3deca81b41ae49eac5f79318c11f665cc8ac1a5f5dbbadefbc8b300000000000000000000000000000000000000000000000000000000066f4120b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000912d8e9969967c000000000000000000000000000000000000000000000000009073baafaf75bb0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a400000000000000000000000000000000000000000000000000000000000000416521e89035c0afc88a3022c8513c32dd2c0b035669093f5f19f91cfee137878f6db1eb0b866d56502a2fdecca33358fe58777742cabc8bff8a12775e7af13e2c1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002644dcebcba0000000000000000000000000000000000000000000000000000000066f411fd000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae1600000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86000000000000000000000000000000000000000000000000000001922964e975000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000711be0300000000000000000000000000000000000000000000000000a110b3d984f910000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae160000000000000000000000000000000000000000000000000000000000000002142a55bf4fe0bbe800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000414dc0c218e52b61b9124403acfd1b852a043beaae10d8c2671a565e7ec0b794550e9cb79696013c9b555cf4b9c35615358adc49c4c65f9ba029726f03c081e7221b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "gas": "0x38842", "gasUsed": "0xabbc", "to": "0x31c2f6fcff4f8759b3bd5bf0e1084a055615c768", "input": "0x137c29fe000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000711be03000468328d3deca81b41ae49eac5f79318c11f665cc8ac1a5f5dbbadefbc8b300000000000000000000000000000000000000000000000000000000066f4120b000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16000000000000000000000000000000000000000000000000000000000711be030000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a47cd33c73177739d79731891669df1b5f27319d0c9e7f6a24d4903968dbde68c90000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000002084578636c757369766544757463684f72646572207769746e6573732944757463684f7574707574286164647265737320746f6b656e2c75696e74323536207374617274416d6f756e742c75696e7432353620656e64416d6f756e742c6164647265737320726563697069656e74294578636c757369766544757463684f72646572284f72646572496e666f20696e666f2c75696e74323536206465636179537461727454696d652c75696e74323536206465636179456e6454696d652c61646472657373206578636c757369766546696c6c65722c75696e74323536206578636c757369766974794f766572726964654270732c6164647265737320696e707574546f6b656e2c75696e7432353620696e7075745374617274416d6f756e742c75696e7432353620696e707574456e64416d6f756e742c44757463684f75747075745b5d206f757470757473294f72646572496e666f28616464726573732072656163746f722c6164647265737320737761707065722c75696e74323536206e6f6e63652c75696e7432353620646561646c696e652c61646472657373206164646974696f6e616c56616c69646174696f6e436f6e74726163742c6279746573206164646974696f6e616c56616c69646174696f6e4461746129546f6b656e5065726d697373696f6e73286164647265737320746f6b656e2c75696e7432353620616d6f756e742900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000416521e89035c0afc88a3022c8513c32dd2c0b035669093f5f19f91cfee137878f6db1eb0b866d56502a2fdecca33358fe58777742cabc8bff8a12775e7af13e2c1b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x31c2f6fcff4f8759b3bd5bf0e1084a055615c768", "gas": "0x34e08", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x04e7a95632c974433eae01961f279430d264722b6dbb0a6131b8e0a3154a1f9c000000000000000000000000000000000000000000000000000000000000001b6521e89035c0afc88a3022c8513c32dd2c0b035669093f5f19f91cfee137878f6db1eb0b866d56502a2fdecca33358fe58777742cabc8bff8a12775e7af13e2c", "output": "0x0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4", "type": "STATICCALL" }, { "from": "0x31c2f6fcff4f8759b3bd5bf0e1084a055615c768", "gas": "0x3375e", "gasUsed": "0x67a2", "to": "0xdac17f958d2ee523a2206206994597c13d831ec7", "input": "0x23b872dd0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16000000000000000000000000000000000000000000000000000000000711be03", "logs": [ { "address": "0xdac17f958d2ee523a2206206994597c13d831ec7", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4", "0x000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16" ], "data": "0x000000000000000000000000000000000000000000000000000000000711be03", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "gas": "0x2d68b", "gasUsed": "0x1d155", "to": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "input": "0x585da628000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000711be03000000000000000000000000000000000000000000000000000000000711be0300000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002407cd33c73177739d79731891669df1b5f27319d0c9e7f6a24d4903968dbde68c900000000000000000000000035db01d1425685789dcc9228d47c7a5c049388d80000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4000468328d3deca81b41ae49eac5f79318c11f665cc8ac1a5f5dbbadefbc8b300000000000000000000000000000000000000000000000000000000066f4120b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000090fc00c17c386b0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a400000000000000000000000000000000000000000000000000000000000000416521e89035c0afc88a3022c8513c32dd2c0b035669093f5f19f91cfee137878f6db1eb0b866d56502a2fdecca33358fe58777742cabc8bff8a12775e7af13e2c1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002644dcebcba0000000000000000000000000000000000000000000000000000000066f411fd000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae1600000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86000000000000000000000000000000000000000000000000000001922964e975000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000711be0300000000000000000000000000000000000000000000000000a110b3d984f910000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae160000000000000000000000000000000000000000000000000000000000000002142a55bf4fe0bbe800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000414dc0c218e52b61b9124403acfd1b852a043beaae10d8c2671a565e7ec0b794550e9cb79696013c9b555cf4b9c35615358adc49c4c65f9ba029726f03c081e7221b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "gas": "0x2c15c", "gasUsed": "0x6179", "to": "0xdac17f958d2ee523a2206206994597c13d831ec7", "input": "0x095ea7b3000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff", "logs": [ { "address": "0xdac17f958d2ee523a2206206994597c13d831ec7", "topics": [ "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925", "0x000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "gas": "0x25065", "gasUsed": "0x138b2", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0x4dcebcba0000000000000000000000000000000000000000000000000000000066f411fd000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae1600000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86000000000000000000000000000000000000000000000000000001922964e975000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000000000000000000000000000000000000711be0300000000000000000000000000000000000000000000000000a110b3d984f910000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae160000000000000000000000000000000000000000000000000000000000000002142a55bf4fe0bbe800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000414dc0c218e52b61b9124403acfd1b852a043beaae10d8c2671a565e7ec0b794550e9cb79696013c9b555cf4b9c35615358adc49c4c65f9ba029726f03c081e7221b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x23b2a", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x4f71c7a1d0a39f15db16a0645e24f6975dcc0546c51e013df81c60480b85ee16000000000000000000000000000000000000000000000000000000000000001b4dc0c218e52b61b9124403acfd1b852a043beaae10d8c2671a565e7ec0b794550e9cb79696013c9b555cf4b9c35615358adc49c4c65f9ba029726f03c081e722", "output": "0x00000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86", "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x1d235", "gasUsed": "0x2dd2", "to": "0xdac17f958d2ee523a2206206994597c13d831ec7", "input": "0x23b872dd000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae1600000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86000000000000000000000000000000000000000000000000000000000711be03", "logs": [ { "address": "0xdac17f958d2ee523a2206206994597c13d831ec7", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16", "0x00000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86" ], "data": "0x000000000000000000000000000000000000000000000000000000000711be03", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x193e8", "gasUsed": "0x3ab1", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd00000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f00000000000000000000000000000000000000000000000000a110b3d984f910", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000067336cec42645f55059eff241cb02ea5cc52ff86", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x00000000000000000000000000000000000000000000000000a110b3d984f910", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x15696", "gasUsed": "0x23f2", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x2e1a7d4d00000000000000000000000000000000000000000000000000a110b3d984f910", "calls": [ { "from": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "gas": "0x8fc", "gasUsed": "0x3e", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0x", "value": "0xa110b3d984f910", "type": "CALL" } ], "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x00000000000000000000000000000000000000000000000000a110b3d984f910", "position": "0x1" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x11870", "gasUsed": "0x37", "to": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "input": "0x", "value": "0xa110b3d984f910", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x00000000000000000000000000000000142a55bf4fe0bbe80000000000000000" ], "data": "0x", "position": "0x5" } ], "value": "0x0", "type": "CALL" }, { "from": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "gas": "0x23f0", "gasUsed": "0x37", "to": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "input": "0x", "value": "0xa110b3d984f910", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "gas": "0x23f0", "gasUsed": "0x0", "to": "0x9d24d495f7380ba80dc114d8c2cf1a54a68e25a4", "input": "0x", "value": "0x90fc00c17c386b", "type": "CALL" }, { "from": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "gas": "0x23f0", "gasUsed": "0x37", "to": "0xf3771ddf312bba0588c50944519b306fb0eeae16", "input": "0x", "value": "0x1014b31808c0a5", "type": "CALL" } ], "logs": [ { "address": "0x35db01d1425685789dcc9228d47c7a5c049388d8", "topics": [ "0x78ad7ec0e9f89e74012afa58738b6b661c024cb0fd185ee2f616c0a28924bd66", "0x7cd33c73177739d79731891669df1b5f27319d0c9e7f6a24d4903968dbde68c9", "0x000000000000000000000000f3771ddf312bba0588c50944519b306fb0eeae16", "0x0000000000000000000000009d24d495f7380ba80dc114d8c2cf1a54a68e25a4" ], "data": "0x000468328d3deca81b41ae49eac5f79318c11f665cc8ac1a5f5dbbadefbc8b30", "position": "0x3" } ], "value": "0x0", "type": "CALL" }`
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	assert.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, event, 1727271335)
	assert.NoError(t, err)
	fmt.Printf("%+v\n", logs)
	log := logs[0]
	assert.Equal(t, log.EventHash, p.eventHash)
	assert.Equal(t, log.Maker, "0xF3771dDF312bBA0588c50944519B306fb0EeaE16")
	assert.Equal(t, log.Taker, "0x9D24d495F7380BA80dC114D8C2cF1a54a68e25A4")
	assert.Equal(t, log.MakerTokenAmount, "40809476822677611")
	assert.Equal(t, log.MakerToken, "0x0000000000000000000000000000000000000000")
	assert.Equal(t, log.TakerTokenAmount, "118603267")
	assert.Equal(t, log.TakerToken, "0xdAC17F958D2ee523a2206206994597C13D831ec7")
	assert.Equal(t, log.Expiry, uint64(1727271435))
	t.Log(log)
}

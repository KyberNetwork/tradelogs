package bebop

import (
	"context"
	"encoding/json"
	types2 "github.com/KyberNetwork/tradelogs/v2/pkg/types"
	"math/big"
	"os"
	"testing"
	"time"

	"github.com/ethereum/go-ethereum"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/test-go/testify/require"
)

var rpcURL = os.Getenv("TEST_RPC_URL")

func TestFetchEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	p := MustNewParser()
	require.Equal(t, p.abi.Events[TradeEvent].ID, common.HexToHash("0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e"))
	client, err := ethclient.Dial(rpcURL)
	require.NoError(t, err)
	logs, err := client.FilterLogs(context.Background(), ethereum.FilterQuery{
		BlockHash: nil,
		FromBlock: big.NewInt(20370147),
		ToBlock:   big.NewInt(20370147),
		Addresses: nil,
		Topics: [][]common.Hash{
			{
				common.HexToHash("0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e"),
			},
		},
	})
	require.NoError(t, err)
	d, err := json.Marshal(logs)
	require.NoError(t, err)
	t.Log(string(d))
}

func TestParseAggregateOrderEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `{"address":"0xbbbbbbb520d69a9775e85b458c58c648259fad5f","topics":["0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e","0x000000000000000000000000000000006f0760aefdfe33400000000000000000"],"data":"0x","blockNumber":"0x138de04","transactionHash":"0xb9d13c7057d6d0779a14023d8ce469a8266ea89eb2ca4e6f4c085ef0929c6f08","transactionIndex":"0x8","blockHash":"0x54a780bfa027b8cfb16a40bb86be066795e84d6a124582f9a85b8c662f27fda9","logIndex":"0x46","removed":false}`
	events := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0xb2f72662ed42067ccce278f8462a0215b6adcabb", "gas": "0x1a712e", "gasUsed": "0x23acd", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0xa2f748930000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000064000000000000000000000000000000000000000000000000000000000019c98330000000000000000000000000000000000000000000000000000000066b8712e000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb00000000000000000000000000000000000000000000000000000000000005a06f0760aefdfe3340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd380000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000003225c27010700000000000000000000000000000000000000000000000017ea9e0274ad8a550000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000001b9c93534400000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000bbc889a7a000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000265c79fcbce5010e1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000104d86da9de19b3a0000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000415237348cdbe0b8f6a4952a303db8ff54f52dcd14eb00bc03f4247be157d0e8ef6eb8cab40c8d8ca015ebd4b980598ca40d2683ebaa79d123902620f214cd0a1f1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000414f1ae3f26c6fa55fafc195a1a6aa6aa3a1c3c16a9c229a3e5035da7a5c3b90f56e193a01cc0fcb4b4aa701f2a9668281c2a4b515b64d38c1760cd350cc26361e1c00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x19cc0c", "gasUsed": "0x13c1", "to": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "input": "0x1626ba7ee92ac74a49c5298319c7a3d28f9463ff238c47be0e0331934bd61c7326e724f6000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000415237348cdbe0b8f6a4952a303db8ff54f52dcd14eb00bc03f4247be157d0e8ef6eb8cab40c8d8ca015ebd4b980598ca40d2683ebaa79d123902620f214cd0a1f1b00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "gas": "0x195e72", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0xe92ac74a49c5298319c7a3d28f9463ff238c47be0e0331934bd61c7326e724f6000000000000000000000000000000000000000000000000000000000000001b5237348cdbe0b8f6a4952a303db8ff54f52dcd14eb00bc03f4247be157d0e8ef6eb8cab40c8d8ca015ebd4b980598ca40d2683ebaa79d123902620f214cd0a1f", "output": "0x000000000000000000000000a0f1898fb62aee04f9aa1aa5866bc48e6b4cb1d8", "type": "STATICCALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x19307c", "gasUsed": "0x1652", "to": "0x807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "input": "0x1626ba7ec6acab902fe662162f5afdc27b1f234e95853ca4a1b33e5ebcfa25dc34977792000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000414f1ae3f26c6fa55fafc195a1a6aa6aa3a1c3c16a9c229a3e5035da7a5c3b90f56e193a01cc0fcb4b4aa701f2a9668281c2a4b515b64d38c1760cd350cc26361e1c00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "gas": "0x18c8fc", "gasUsed": "0x135f", "to": "0xbe4e645caaae7c1d0874bb8d1c8d337f31d79dd8", "input": "0x1626ba7ec6acab902fe662162f5afdc27b1f234e95853ca4a1b33e5ebcfa25dc34977792000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000414f1ae3f26c6fa55fafc195a1a6aa6aa3a1c3c16a9c229a3e5035da7a5c3b90f56e193a01cc0fcb4b4aa701f2a9668281c2a4b515b64d38c1760cd350cc26361e1c00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "gas": "0x185ff4", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x1775a963b623a6f19aef44c47b6f1eec625d40b2c09fe0e5577f1b9a5b33f000000000000000000000000000000000000000000000000000000000000000001c4f1ae3f26c6fa55fafc195a1a6aa6aa3a1c3c16a9c229a3e5035da7a5c3b90f56e193a01cc0fcb4b4aa701f2a9668281c2a4b515b64d38c1760cd350cc26361e", "output": "0x000000000000000000000000e9f191c09679a745a1d7a7f20658681b18d9a31a", "type": "STATICCALL" } ], "value": "0x0", "type": "DELEGATECALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x18851b", "gasUsed": "0xd61", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb000000000000000000000000000000000000000000000000001923f279b01e91", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb" ], "data": "0x000000000000000000000000000000000000000000000000001923f279b01e91", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x1866e5", "gasUsed": "0x1995", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x23b872dd000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000000001218761", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x180267", "gasUsed": "0x167a", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x23b872dd000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000000001218761", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f" ], "data": "0x0000000000000000000000000000000000000000000000000000000001218761", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x182f69", "gasUsed": "0x1851", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb000000000000000000000000000000000000000000000000000aaf2991253dc1", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38", "0x000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb" ], "data": "0x000000000000000000000000000000000000000000000000000aaf2991253dc1", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x18066f", "gasUsed": "0x2485", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x23b872dd000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd3800000000000000000000000000000000000000000000000000000000007b10d1", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x17a372", "gasUsed": "0x216a", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x23b872dd000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd3800000000000000000000000000000000000000000000000000000000007b10d1", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000b2f72662ed42067ccce278f8462a0215b6adcabb", "0x000000000000000000000000807cf9a772d5a3f9cefbc1192e939d62f0d9bd38" ], "data": "0x00000000000000000000000000000000000000000000000000000000007b10d1", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x000000000000000000000000000000006f0760aefdfe33400000000000000000" ], "data": "0x", "position": "0x6" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, events, uint64(time.Now().Unix()))
	require.NoError(t, err)
	for _, log := range logs {
		require.Equal(t, log.EventHash, p.eventHash)
		t.Log(log.Maker)
		t.Log(log.MakerToken)
		t.Log(log.MakerTokenAmount)
		t.Log(log.Taker)
		t.Log(log.TakerToken)
		t.Log(log.TakerTokenAmount)
		t.Log("---------------------")
	}
}

func TestParseAggregateOrderEvent2(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `{"address":"0xbbbbbbb520d69a9775e85b458c58c648259fad5f","topics":["0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e","0x0000000000000000000000000000000000000000000000000000000000000000"],"data":"0x","blockNumber":"0x1443cc5","transactionHash":"0xe28041915a516e729bdbf397f79a570d62071216bbda42797062c550be7e71b6","transactionIndex":"0x1","blockHash":"0xa179050f766d694f030e137f924a5d4de2c90bcce223d7a5df52af02b12c6b5e","logIndex":"0x14","removed":false}`
	events := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0xf7dc4ab21a6d8e7a573c13516cf3419b4b8a0002", "gas": "0x3bf47", "gasUsed": "0x1e756", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0xa2f74893000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000004c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006741916c000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000380000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a000200000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000004b9ccbb0a44000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000dc25127cc000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000ea0149b816498000000000000000000000000000000000000000000000000000089c7ce1eb5e6f8000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000416fda3da1cb665ab572b50d5b93c5adc3bbe8a176d23a33d6fca2287d3b6239eb72079e06970a3e5d630379183f41475a5cbe0809f910055e76bad14b47c232eb1b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x36a15", "gasUsed": "0x2b31", "to": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "input": "0x1626ba7e56ffa4818cf4a457392fe77d42aa95b26a01f84038c203bcb556902577aba78d000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000416fda3da1cb665ab572b50d5b93c5adc3bbe8a176d23a33d6fca2287d3b6239eb72079e06970a3e5d630379183f41475a5cbe0809f910055e76bad14b47c232eb1b00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "gas": "0x33ef1", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x56ffa4818cf4a457392fe77d42aa95b26a01f84038c203bcb556902577aba78d000000000000000000000000000000000000000000000000000000000000001b6fda3da1cb665ab572b50d5b93c5adc3bbe8a176d23a33d6fca2287d3b6239eb72079e06970a3e5d630379183f41475a5cbe0809f910055e76bad14b47c232eb", "output": "0x000000000000000000000000a0f1898fb62aee04f9aa1aa5866bc48e6b4cb1d8", "type": "STATICCALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x2bb3d", "gasUsed": "0x75ad", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002000000000000000000000000000000000000000000000000ea0149b816498000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002" ], "data": "0x000000000000000000000000000000000000000000000000ea0149b816498000", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x240f4", "gasUsed": "0xd61", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002000000000000000000000000000000000000000000000000089c7ce1eb5e6f80", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002" ], "data": "0x000000000000000000000000000000000000000000000000089c7ce1eb5e6f80", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x2234f", "gasUsed": "0x46e5", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x23b872dd000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a000200000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000000dc25127cc", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x217df", "gasUsed": "0x43ca", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x23b872dd000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a000200000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000000dc25127cc", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000f7dc4ab21a6d8e7a573c13516cf3419b4b8a0002", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f" ], "data": "0x0000000000000000000000000000000000000000000000000000000dc25127cc", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x0000000000000000000000000000000000000000000000000000000000000000" ], "data": "0x", "position": "0x4" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, events, uint64(time.Now().Unix()))
	require.NoError(t, err)
	for _, log := range logs {
		require.Equal(t, log.EventHash, p.eventHash)
		t.Log(log.Maker)
		t.Log(log.MakerToken)
		t.Log(log.MakerTokenAmount)
		t.Log(log.Taker)
		t.Log(log.TakerToken)
		t.Log(log.TakerTokenAmount)
		t.Log("---------------------")
	}
}

func TestParseMultiOrderEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `{"address":"0xbbbbbbb520d69a9775e85b458c58c648259fad5f","topics":["0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e","0x0000000000000000000000000000000027611cb25303fa700000000000000001"],"data":"0x","blockNumber":"0x133842c","transactionHash":"0xff46ac555ec7da7aa484864dc0df90217b7f46dfa51627c20ef6e25451c64b15","transactionIndex":"0x10","blockHash":"0xb03cd01d48456c60cdf445e35b0a4d7672b80d801245e516336596f0d5b77951","logIndex":"0x85","removed":false}`
	events := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0xf3a900dcdb231ce2d7dc151f7dd6f8998a8ffe12", "gas": "0x78c55", "gasUsed": "0x529d2", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0xefe34fe600000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000006677e5f6000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000019035521cc2000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae000000000000000000000000000000000000000000000000000000000000036027611cb25303fa700000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000005000000000000000000000000ba100000625a3754423978a60c9317c58a424e3d0000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000c00e94cb662c3520282e6f5717214004a7f26888000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000006b3595068778dd592e39a122f4f5a5cf09c90fe20000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000c6f3b40b6c000000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000005cdfef153c9bf1200000000000000000000000000000000000000000000000012533b012f073674000000000000000000000000000000000000000000000000005f06b05e7df1e30000000000000000000000000000000000000000000000000000000000142659000000000000000000000000000000000000000000000000166782e60b284084000000000000000000000000000000000000000000000000000000000000000600000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000417bc45cd5dd6fae69dfbf0f34c2115192ffdb5e966d005283e2319cfc95ba32e72cd37f143134a84ed5a6e8fd64b493761583fb7542d62c62eb9f0f2042b760b21c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000019035521cc2000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000005cdfef153c9bf1200000000000000000000000000000000000000000000000012533b012f073674000000000000000000000000000000000000000000000000005f06b05e7df1e30000000000000000000000000000000000000000000000000000000000142659000000000000000000000000000000000000000000000000166782e60b28408400000000000000000000000000000000000000000000000000000000000000419364219dffe3fbdac998527e90ee0db51b9922bda478024eabbb3f79d34224b041fafda2e7ae36f13893996c216137f4ff7f3cfe47a9dc5366a0514553400afb1b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x6b4ac", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x0771c9c83a043f704503dd95ca00c79bb97d926d5578e292e3e4eb966dab5db2000000000000000000000000000000000000000000000000000000000000001b9364219dffe3fbdac998527e90ee0db51b9922bda478024eabbb3f79d34224b041fafda2e7ae36f13893996c216137f4ff7f3cfe47a9dc5366a0514553400afb", "output": "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae", "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x67cf7", "gasUsed": "0x2b4b", "to": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "input": "0x1626ba7e0771c9c83a043f704503dd95ca00c79bb97d926d5578e292e3e4eb966dab5db2000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000417bc45cd5dd6fae69dfbf0f34c2115192ffdb5e966d005283e2319cfc95ba32e72cd37f143134a84ed5a6e8fd64b493761583fb7542d62c62eb9f0f2042b760b21c00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "gas": "0x6456e", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x0771c9c83a043f704503dd95ca00c79bb97d926d5578e292e3e4eb966dab5db2000000000000000000000000000000000000000000000000000000000000001c7bc45cd5dd6fae69dfbf0f34c2115192ffdb5e966d005283e2319cfc95ba32e72cd37f143134a84ed5a6e8fd64b493761583fb7542d62c62eb9f0f2042b760b2", "output": "0x000000000000000000000000a0f1898fb62aee04f9aa1aa5866bc48e6b4cb1d8", "type": "STATICCALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x62103", "gasUsed": "0x50fc", "to": "0x000000000022d473030f116ddee9f6b43ac78ba3", "input": "0x36c78516000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000c6f3b40b6c000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "calls": [ { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x5f2d4", "gasUsed": "0x3ab1", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000000000000000000000000000000c6f3b40b6c000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f" ], "data": "0x000000000000000000000000000000000000000000000000000c6f3b40b6c000", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x5bb5f", "gasUsed": "0xb161", "to": "0xba100000625a3754423978a60c9317c58a424e3d", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae00000000000000000000000000000000000000000000000005cdfef153c9bf12", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xba100000625a3754423978a60c9317c58a424e3d", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae" ], "data": "0x00000000000000000000000000000000000000000000000005cdfef153c9bf12", "position": "0x0" }, { "address": "0xba100000625a3754423978a60c9317c58a424e3d", "topics": [ "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x00000000000000000000000000000000000000000000029e829c0b68b97518ab", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x4fcb1", "gasUsed": "0x8db3", "to": "0x6b175474e89094c44da98b954eedeac495271d0f", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae00000000000000000000000000000000000000000000000012533b012f073674", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0x6b175474e89094c44da98b954eedeac495271d0f", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae" ], "data": "0x00000000000000000000000000000000000000000000000012533b012f073674", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x46122", "gasUsed": "0xaad8", "to": "0xc00e94cb662c3520282e6f5717214004a7f26888", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae000000000000000000000000000000000000000000000000005f06b05e7df1e3", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc00e94cb662c3520282e6f5717214004a7f26888", "topics": [ "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x00000000000000000000000000000000000000000000002bef9b63feab16598b", "position": "0x0" }, { "address": "0xc00e94cb662c3520282e6f5717214004a7f26888", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae" ], "data": "0x000000000000000000000000000000000000000000000000005f06b05e7df1e3", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x3a8e2", "gasUsed": "0xbda5", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae0000000000000000000000000000000000000000000000000000000000142659", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x37e5d", "gasUsed": "0xa126", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae0000000000000000000000000000000000000000000000000000000000142659", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae" ], "data": "0x0000000000000000000000000000000000000000000000000000000000142659", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x2de21", "gasUsed": "0x92cc", "to": "0x6b3595068778dd592e39a122f4f5a5cf09c90fe2", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae000000000000000000000000000000000000000000000000166782e60b284084", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0x6b3595068778dd592e39a122f4f5a5cf09c90fe2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000589c86cc1f6043f99222843d397ea4e770841cae" ], "data": "0x000000000000000000000000000000000000000000000000166782e60b284084", "position": "0x0" }, { "address": "0x6b3595068778dd592e39a122f4f5a5cf09c90fe2", "topics": [ "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x000000000000000000000000000000000000000000000984a6174af54d13f8f8", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x0000000000000000000000000000000027611cb25303fa700000000000000001" ], "data": "0x", "position": "0x8" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, events, uint64(time.Now().Unix()))
	require.NoError(t, err)
	for _, log := range logs {
		m, _ := json.Marshal(log)
		t.Log(string(m))
		require.Equal(t, log.EventHash, p.eventHash)
		t.Log(log.Maker)
		t.Log(log.MakerToken)
		t.Log(log.MakerTokenAmount)
		t.Log(log.Taker)
		t.Log(log.TakerToken)
		t.Log(log.TakerTokenAmount)
		t.Log("---------------------")
	}
}

func TestParseSingleOrderEvent(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `{"address":"0xbbbbbbb520d69a9775e85b458c58c648259fad5f","topics":["0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e","0x0000000000000000000000000000000084e2ab041ba07e400000000000000000"],"data":"0x","blockNumber":"0x1302413","transactionHash":"0xa227c4aed6f3ae86cd8ba02349d0ae5be78337266416ac65cf8a8d095a2f572e","transactionIndex":"0x47","blockHash":"0xbb4a5ae13e2a66f83f444f24078ac3fb6d0b09f610c48d920d3b89d4f20ea86c","logIndex":"0xd8","removed":false}`
	events := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0x6f173d7d735d1564d280ec752eb3141b0f32bef9", "gas": "0x50c45", "gasUsed": "0x26ca2", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0x1a49902600000000000000000000000000000000000000000000000000000000664f238e000000000000000000000000424861f5f81362e99d052712479fe892d9593bb800000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000000000018f818c60ac000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000008ac7230489e800000000000000000000000000000000000000000000000000008ab929ba00928dfb000000000000000000000000424861f5f81362e99d052712479fe892d9593bb8000000000000000000000000000000000000000000000000000000000000000684e2ab041ba07e400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000008ab86eae3041e87e0000000000000000000000000000000000000000000000000000018f818c60a800000000000000000000000000000000000000000000000000000000000002e00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000412b52bc6ca15a798499382ff79bcce23a6e23c95304787f6b4042bdc74847d5b1030c0599ca7d74b493425c889dc656b12410e86db5c6ddf40e0f2902525a39791b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041cd4847ead7bf5322aa1dbaf730a27daeee9a0d30ea9b96390d2a606073125d1b07c65158609e52726c06022632a2e33f5c1d3d97789c7672c01bba01226443041b00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x46b33", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x53c4dcff413019e2b96c8faa030ea422378cc5a42ba3b37a493df5abed4adfd8000000000000000000000000000000000000000000000000000000000000001bcd4847ead7bf5322aa1dbaf730a27daeee9a0d30ea9b96390d2a606073125d1b07c65158609e52726c06022632a2e33f5c1d3d97789c7672c01bba0122644304", "output": "0x000000000000000000000000424861f5f81362e99d052712479fe892d9593bb8", "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x44b3d", "gasUsed": "0x2b31", "to": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "input": "0x1626ba7ea2ad9977f200bd5784e053ba83f8758417b5e95ec467758884de501f73c680d3000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000412b52bc6ca15a798499382ff79bcce23a6e23c95304787f6b4042bdc74847d5b1030c0599ca7d74b493425c889dc656b12410e86db5c6ddf40e0f2902525a39791b00000000000000000000000000000000000000000000000000000000000000", "output": "0x1626ba7e00000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0x51c72848c68a965f66fa7a88855f9f7784502a7f", "gas": "0x41c94", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0xa2ad9977f200bd5784e053ba83f8758417b5e95ec467758884de501f73c680d3000000000000000000000000000000000000000000000000000000000000001b2b52bc6ca15a798499382ff79bcce23a6e23c95304787f6b4042bdc74847d5b1030c0599ca7d74b493425c889dc656b12410e86db5c6ddf40e0f2902525a3979", "output": "0x000000000000000000000000a0f1898fb62aee04f9aa1aa5866bc48e6b4cb1d8", "type": "STATICCALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x40ceb", "gasUsed": "0xdde3", "to": "0x000000000022d473030f116ddee9f6b43ac78ba3", "input": "0x36c78516000000000000000000000000424861f5f81362e99d052712479fe892d9593bb800000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000ae7ab96520de3a18e5e111b5eaab095312d7fe84", "calls": [ { "from": "0x000000000022d473030f116ddee9f6b43ac78ba3", "gas": "0x3e70c", "gasUsed": "0xc798", "to": "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "input": "0x23b872dd000000000000000000000000424861f5f81362e99d052712479fe892d9593bb800000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000008ac7230489e80000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "gas": "0x3bad1", "gasUsed": "0x2047", "to": "0xb8ffc3cd6e7cf5a098a1c92f48009765b24088dc", "input": "0xbe00bbd8f1f3eb40f5bc1ad1344716ced8b8a0431d840b5783aea1fd01786bc26f35ac0f3ca7c3e38968823ccb4c78ea688df41356f182ae1d159e4ee608d30d68cef320", "output": "0x00000000000000000000000017144556fd3424edc8fc8a4c940b2d04936d17eb", "calls": [ { "from": "0xb8ffc3cd6e7cf5a098a1c92f48009765b24088dc", "gas": "0x37f1b", "gasUsed": "0xb04", "to": "0x2b33cf282f867a7ff693a66e11b0fcc5552e4425", "input": "0xbe00bbd8f1f3eb40f5bc1ad1344716ced8b8a0431d840b5783aea1fd01786bc26f35ac0f3ca7c3e38968823ccb4c78ea688df41356f182ae1d159e4ee608d30d68cef320", "output": "0x00000000000000000000000017144556fd3424edc8fc8a4c940b2d04936d17eb", "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "gas": "0x376cd", "gasUsed": "0x7dcc", "to": "0x17144556fd3424edc8fc8a4c940b2d04936d17eb", "input": "0x23b872dd000000000000000000000000424861f5f81362e99d052712479fe892d9593bb800000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f0000000000000000000000000000000000000000000000008ac7230489e80000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000424861f5f81362e99d052712479fe892d9593bb8", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f" ], "data": "0x0000000000000000000000000000000000000000000000008ac7230489e80000", "position": "0x0" }, { "address": "0xae7ab96520de3a18e5e111b5eaab095312d7fe84", "topics": [ "0x9d9c909296d9c674451c0c24f02cb64981eb3b727f99865939192f880a755dcb", "0x000000000000000000000000424861f5f81362e99d052712479fe892d9593bb8", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f" ], "data": "0x00000000000000000000000000000000000000000000000076e18d05cbaad440", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x321e8", "gasUsed": "0x8b40", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f0000000000000000000000000000000000000000000000008ab86eae3041e87e", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x00000000000000000000000051c72848c68a965f66fa7a88855f9f7784502a7f", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x0000000000000000000000000000000000000000000000008ab86eae3041e87e", "position": "0x0" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x29548", "gasUsed": "0x23f2", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x2e1a7d4d0000000000000000000000000000000000000000000000008ab86eae3041e87e", "calls": [ { "from": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "gas": "0x8fc", "gasUsed": "0x3e", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0x", "value": "0x8ab86eae3041e87e", "type": "CALL" } ], "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f" ], "data": "0x0000000000000000000000000000000000000000000000008ab86eae3041e87e", "position": "0x1" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x24d85", "gasUsed": "0x0", "to": "0x424861f5f81362e99d052712479fe892d9593bb8", "input": "0x", "value": "0x8ab86eae3041e87e", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x0000000000000000000000000000000084e2ab041ba07e400000000000000000" ], "data": "0x", "position": "0x6" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, events, uint64(time.Now().Unix()))
	require.NoError(t, err)
	log := logs[0]
	require.Equal(t, log.EventHash, p.eventHash)
	t.Log(log.Maker)
	t.Log(log.MakerToken)
	t.Log(log.MakerTokenAmount)
	t.Log(log.Taker)
	t.Log(log.TakerToken)
	t.Log(log.TakerTokenAmount)
}

func TestParseSwapSingleFromContract(t *testing.T) {
	t.Skip("Need to add the rpc url that enables the trace call JSON-RPC")
	eventRaw := `{"address":"0xbbbbbbb520d69a9775e85b458c58c648259fad5f","topics":["0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e","0x0000000000000000000000000000000000000000000000000000000000000000"],"data":"0x","blockNumber":"0x13e7401","transactionHash":"0x4b15bfb1024c71eb76a48dbf1d0faea77044433807e2052dbb3a00b3ee054a14","transactionIndex":"0x3f","blockHash":"0x4161ffa4596f3bd812959e7a91038a26d27f57aa51d9ef3ee4cd0772d11c86fe","logIndex":"0x176","removed":false}`
	events := types.Log{}
	err := json.Unmarshal([]byte(eventRaw), &events)
	require.NoError(t, err)

	callFrameRaw := `{ "from": "0x5eadac244c868c1ac2d02c34d7cae524130e13c5", "gas": "0x1afc8", "gasUsed": "0x1abcf", "to": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "input": "0xc38a44740000000000000000000000000000000000000000000000000000000066fbd3910000000000000000000000005eadac244c868c1ac2d02c34d7cae524130e13c5000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce310000000000000000000000000000000000000000000000000000000007ced0b2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000015752a0000000000000000000000000000000000000000000000000000000e8d4a510000000000000000000000000005eadac244c868c1ac2d02c34d7cae524130e13c5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041162616cbb90a7655e2ef7d1b233988103167a611161eab9546c8c0e32b9c892e76de9645566ea735ae197da51a4d9c6b15aa4a9f1aa5d5431e4b78e23420a3031c00000000000000000000000000000000000000000000000000000000000000", "calls": [ { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x1389d", "gasUsed": "0x266f", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0x70a08231000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f", "output": "0x000000000000000000000000000000000000000000000000000000000157c00e", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x117e2", "gasUsed": "0x9f9", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0x70a08231000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f", "output": "0x000000000000000000000000000000000000000000000000000000000157c00e", "value": "0x0", "type": "DELEGATECALL" } ], "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x107c1", "gasUsed": "0xbb8", "to": "0x0000000000000000000000000000000000000001", "input": "0x7e85a7103d97461b52d30d87688c6b7bb4bc08267f0dff8491e77672bcb8dc71000000000000000000000000000000000000000000000000000000000000001c162616cbb90a7655e2ef7d1b233988103167a611161eab9546c8c0e32b9c892e76de9645566ea735ae197da51a4d9c6b15aa4a9f1aa5d5431e4b78e23420a303", "output": "0x000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce31", "type": "STATICCALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x9dec", "gasUsed": "0x3acc", "to": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "input": "0xa9059cbb000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce3100000000000000000000000000000000000000000000000000000000015752a0", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "calls": [ { "from": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "gas": "0x9897", "gasUsed": "0x37b7", "to": "0x43506849d7c04f9138d1a2050bbf3a0c054402dd", "input": "0xa9059cbb000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce3100000000000000000000000000000000000000000000000000000000015752a0", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000bbbbbbb520d69a9775e85b458c58c648259fad5f", "0x000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce31" ], "data": "0x00000000000000000000000000000000000000000000000000000000015752a0", "position": "0x0" } ], "value": "0x0", "type": "DELEGATECALL" } ], "value": "0x0", "type": "CALL" }, { "from": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "gas": "0x51f3", "gasUsed": "0x4874", "to": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "input": "0x23b872dd000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce310000000000000000000000005eadac244c868c1ac2d02c34d7cae524130e13c5000000000000000000000000000000000000000000000000000000e8d4a51000", "output": "0x0000000000000000000000000000000000000000000000000000000000000001", "logs": [ { "address": "0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2", "topics": [ "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef", "0x000000000000000000000000fdac654877e7e9a89ae5cb37caf30318ebd5ce31", "0x0000000000000000000000005eadac244c868c1ac2d02c34d7cae524130e13c5" ], "data": "0x000000000000000000000000000000000000000000000000000000e8d4a51000", "position": "0x0" } ], "value": "0x0", "type": "CALL" } ], "logs": [ { "address": "0xbbbbbbb520d69a9775e85b458c58c648259fad5f", "topics": [ "0xadd7095becdaa725f0f33243630938c861b0bba83dfd217d4055701aa768ec2e", "0x0000000000000000000000000000000000000000000000000000000000000000" ], "data": "0x", "position": "0x4" } ], "value": "0x0", "type": "CALL" }`
	var callFrame types2.CallFrame
	err = json.Unmarshal([]byte(callFrameRaw), &callFrame)
	require.NoError(t, err)

	p := MustNewParser()
	logs, err := p.ParseWithCallFrame(callFrame, events, uint64(time.Now().Unix()))
	require.NoError(t, err)
	log := logs[0]
	require.Equal(t, log.EventHash, p.eventHash)
	t.Log(log.Maker)
	t.Log(log.MakerToken)
	t.Log(log.MakerTokenAmount)
	t.Log(log.Taker)
	t.Log(log.TakerToken)
	t.Log(log.TakerTokenAmount)
}
